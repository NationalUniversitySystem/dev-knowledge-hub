# LinkedIn Lead Gen 

**Context**: NU's Paid Media team uses social media channels (Facebook & LinkedIn) for lead generation. In order to get these leads into our CRM (Eloqua/DP/Sparkroom) for the NU Enrollment team to work them, we first pass them through a custom API we created on NUSAServices.com. We do this so that we can process additional information (supplier ID, UTMs, etc) and properly map the data to match required CRM fields. 

**Basic data/process flow**: 
![LinkedIn Leadgen Process Flow](../_images/linkedin-leadgen-process-flow.png)

1) Prospective student fills out RFI on LinkedIn
2) "Lead" gets created on NU's LinkedIn Campaign Manager (linkedin.com/campaignmanager)
3) NU's LinkedIn Developer Console App fires a webhook to our internal NUSAservices.com API. 
    - Note: This webhook does not contain personal information, only a series of ID numbers.
4) NUSAServices API creates a GravityForm entry for the "LinkedIn Webhook Notifications" Form, using the webhook data.
5) NUSAServices API sends a request to the LinkedIn Developer Console App to authorize our access token.
6) If the access token is active and authorized, we then send a request to the LinkedIn Campaign Manager App to fetch the full Lead information based on the ID #'s contained in the initial webhook (step 3).
7) After receiving the full lead info, NUSAServices API proceeds with our "standard RFI data processing" (determine supplier ID, UTM parameters, map data fields & formats, etc).
8) Create a new GravityForm entry in the "CRM Webhooks - LinkedIn" Form. This entry should essentially match our standard RFI entries that we collect on nu.edu and info.nu.
9) Form data is then sent to CRM (Eloqua/DP/Sparkroom) via standard webhook functionality we use everywhere else.

## Access Tokens

!> If Paid Media is reporting that LinkedIn Leads are not making it through to CRM, it's **probably** a bad Access Token (step #5 above)

In order for the above process to work (i.e. everything after step #5), we need to have a valid "Access Token" generated by the LinkedIn Developer Console. **These access tokens expire after 2 months and need to be regenerated.**

Token generation is handled via the wp-admin on NUSAServices.com. When a token is generated, it is stored within the WordPress database, and then used for all future LinkedIn API requests until it expires.

### How to Tell if Our Current Access Token has Expired

1) Via the WP-CLI: `vip@2801.production wp option get nusa_nu_linkedin_token`
 - This will return an array that contains a 'expires' value. This value is a unix timestamp that will need to be converted via a tool like https://www.epochconverter.com/
 - If the date is in the past, then our token is expired and we need to generate a new one.
 - Note: `2801.production` tells WPVIP we want to run the command on the `production` environment of nusaservices.com (which has a WPVIP app ID of `2801`).

2) Manually check & compare GravityForm entries via wp-admin
	- "Initial" entries are saved to the "**LinkedIn Webhook Notifications**" form on NUSAServices.
	- "Final" entries are saved to the "**CRM Webhooks - LinkedIn - NU**" form on NUSAServices.
	- If our access token is good, entries will match across both forms (compare '**Form Response ID**' values)
	- If our access token is expired, there will be extra entries in the "initial" form that are not present in the "final" form.

### How to Generate a New Access Token

**Prerequisites:**
- Need login credentials for an "authorized" LinkedIn account
	- Currently authorized: Dan & Kyle. Note that these are *personal accounts* that are granted access. We previously had a project in the works to transfer sole authorization to "Natalie Upton", a fake-name account created by the social media team for the purpose us not having this entire API process rely on a single dev's personal account. Alex had previously been working on this but it got put on hold with his departure.
- In order for an account to be "fully authorized":
	- Added to our "NU.edu Leads" app on the LinkedIn Developer Console (developer.linkedin.com -> Team Members)
	- Added to our NU Campaign Manager/Ad Account with 'Account Manager' capabilities (linkedin.com/campaignmanager)
	- Added to our Business page admin with 'Super Admin' capabilities (https://www.linkedin.com/school/210965/admin/) 

**New Access Token Process:**
1) Login to nusaservices.com/wp-admin
2) Navigate to Settings -> LinkedIn API
3) Select the "National University" menu tab
4) Do not change any of the inputs!
5) At the bottom of the page, click the "Request Authorization Code" button
6) Your browser should redirect you to a LinkedIn sign-on screen. Sign in with your authorized account.
7) If everything works, you should be redirected back to nusaservices.com with a JSON object of {status: true}
8) If you get anything other than {status: true}, token generation failed. Double-check prerequisites above and try again.

## Manually Pushing Leads to CRM

If our Access Token expires, initial webhook leads sent from LinkedIn will still make it into nusaservices.com but they will be unable to be processed and passed to CRM. This means that these leads are not "lost", only "stuck". Once we regenerate a new Access Token, we can manually push any stuck leads to our CRM.

**Process:**
1) Navigate to wp-admin Settings -> LinkedIn API
2) At the bottom of the page, click the "Fetch Responses" button
3) Select the date range that leads will need to be processed for (i.e. from the day our token expired thru today)
    - **NOTE** Processing takes awhile. If our access token has been expired for multiple days, probably a good idea to only run this for one or two days at a time, and then repeat until you catch up to the current day. Not sure if the API will time out.
4) If everything worked, you'll see a page telling you how many leads have been processed.
    - If you get an error, double check that: a) We're using an active access token, and b) The account used to generate the access token has the applicable authorization levels (see Access Token prerequisites, above)
5) Manually check & compare GravityForm entires
    - Form: LinkedIn Webhook Notifications, check 'state' field for list of entries. Successful entries should say 'Processed'. If any entries say 'New', then select them via checkbox and do Bulk Actions->Import Notifications

## Resources/References
- LinkedIn Developer Console: https://developer.linkedin.com
- LinkedIn Campaign Manager Dashboard: https://linkedin.com/campaignmanager
- LinkedIn NU School Page: https://www.linkedin.com/school/210965/admin/
- LI API Lead Gen Authorization Reference: https://www.linkedin.com/help/lms/answer/a421620/permissions-for-lead-gen-forms?lang=en
- LI Lead Gen Webhook reference: https://learn.microsoft.com/en-us/linkedin/marketing/integrations/lead-gen/ads-leadgen?view=li-lms-2022-09&tabs=http#lead-notification-content
- FB webhooks dev docs: https://developers.facebook.com/docs/graph-api/webhooks/ 
- FB app inside of FB developers dashboard: https://developers.facebook.com/apps/655915921954022/dashboard/?business_id=10152303787876404 


-------------------------------------------------------------------------------------------------
### Steps to copy token over to other affiliates 
!> **Everything below is "legacy info"** -- NCU & CityU used to also use the same nusaservices API for LinkedIn leadgen flow, so we would need to manually copy/paste Access Token values so they could be used by all 3 affiliates. NCU & CityU no longer use LinkedIn leads, thus we no longer need to do this. Leaving the info here for now though, just in case.

The most convenient way to do this is to use the WP CLI tool to copy settings over since these are saved in the options table of the database, which there is no direct access to on WPVIP hosting. 
- Use the WP VIP CLI tool with the vip wp command. 
- Select the nusaservices app. 
- Select “production” environment. 
- Get the NU options: wp option get nusa_nu_linkedin_token which follows the format wp option get nusa_{uni_slug}_linkedin_token. 
- The result will be an array with the needed data. 
	- Specific data needed is “access_token”, “refresh_token”, and “expires” 
	- Both tokens are long strings 
	- Expires date is an Epoch Unix timestamp. 
- Commands to update the other affiliates options: 
	- wp option patch update nusa_ncu_linkedin_token access_token XXXXXXXXXXXXXXXXXxxxXXXxxxxXXxxxxxxxXXXX 
	- wp option patch update nusa_ncu_linkedin_token refresh_token XXXXXXXXXXXXXXXXXxxxXXXxxxxXXxxxxxxxXXXX 
	- wp option patch update nusa_{uni_slug}_linkedin_token expires 111111111 
	- uni_slug options include cityu, ncu, and nu. 
- Take note of the “expire” option and convert it online with a tool such as unixtimestamp.com so a calendar reminder can be set. 



Location of settings in the admin dashboard: 

![LinkedIn Token Screenshot - 1](../_images/linkedin-token-1.png)

Example of settings when pulled by WP CLI: 

![LinkedIn Token Screenshot - 2](../_images/linkedin-token-2.png)